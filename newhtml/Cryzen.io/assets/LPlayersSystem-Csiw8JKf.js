var L=Object.defineProperty;var k=(h,t,e)=>t in h?L(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var m=(h,t,e)=>(k(h,typeof t!="symbol"?t+"":t,e),e);var z=(h,t,e)=>new Promise((r,s)=>{var o=l=>{try{y(e.next(l))}catch(i){s(i)}},n=l=>{try{y(e.throw(l))}catch(i){s(i)}},y=l=>l.done?r(l.value):Promise.resolve(l.value).then(o,n);y((e=e.apply(h,t)).next())});import{a as F,c as _,R as S,L as E,ae as I,af as C,p as N,ag as U,A as H,ah as j,M as v,P as V,D as K,C as $,ai as R,aj as W,ak as Y,V as X,q as D,s as Z}from"./ResourceLoader-DSKOvWHX.js";import{a6 as a,f as d,bc as q}from"./index-BszMCtG6.js";import{O as J,G as O}from"./OrbitControlsSystem-uYz8zjvc.js";import{L as Q}from"./LResponsiveCameraSystem-0JRIj-uC.js";import"./loadout-BvPo_gCl.js";class ne{constructor(t){m(this,"priority",F.DEFAULT);m(this,"disposed",!1);m(this,"lobbyScene");m(this,"localPlayerNameData");m(this,"players",{});m(this,"WEAPONS_TRANSFORMS",{idle1:{[a.CROSSBOW]:{rot:{x:-2.0691,y:-1.4503,z:-.203},pos:{x:1.6061,y:10.4291,z:2.2678}},[a.VSS_VINTOREZ]:{rot:{x:-1.4503,y:-1.4503,z:-.203},pos:{x:-1.7026,y:8.4439,z:-1.0408}},[a.AKM]:{rot:{x:-1.4503,y:-1.4503,z:-.203},pos:{x:.2361,y:5.7505,z:-3.0725}},[a.AA12]:{rot:{x:-1.4454,y:-1.5147,z:.3562},pos:{x:-.4101,y:3.7808,z:4.4426}},[a.AWM]:{rot:{x:-1.6533,y:-3.3857,z:-3.1086},pos:{x:-6.9964,y:-5.4523,z:20.1345}},[a.KRISS_VECTOR]:{rot:{x:-1.4454,y:-1.3761,z:.1484},pos:{x:-.3791,y:7.1205,z:-.3791}},[a.M14]:{rot:{x:-1.5147,y:-1.7919,z:-.203},pos:{x:7.5616,y:7.1205,z:-4.3494}},[a.M4A1]:{rot:{x:-1.4454,y:-1.5147,z:.3562},pos:{x:.9444,y:4.4736,z:.9444}},[a.MG34]:{rot:{x:-1.6532,y:-3.3164,z:-3.1778},pos:{x:-7.6581,y:1.8267,z:22.1196}},[a.MOSSBERG]:{rot:{x:-1.7226,y:-1.4503,z:-.203},pos:{x:.2361,y:3.8118,z:-1.7025}},[a.MP5]:{rot:{x:-1.9305,y:-1.4503,z:-.203},pos:{x:.2361,y:3.8118,z:-1.0408}},[a.HK_MG5]:{rot:{x:-1.6779,y:-1.4503,z:-.203},pos:{x:-.6178,y:5.5566,z:-3.0725}},[a.MPX_COPPERHEAD]:{rot:{x:-1.6779,y:-1.5397,z:-.203},pos:{x:.0422,y:4.2367,z:-3.0725}}},idle2:{[a.CROSSBOW]:{rot:{x:-2.1464,y:-1.2801,z:-.2092},pos:{x:-.3636,y:11.0036,z:2.504}},[a.VSS_VINTOREZ]:{rot:{x:-1.7355,y:-1.2801,z:-.2092},pos:{x:-3.0105,y:9.0184,z:-.8512}},[a.AKM]:{rot:{x:-1.7355,y:-1.2801,z:-.2092},pos:{x:-1.7336,y:6.325,z:-.8512}},[a.AA12]:{rot:{x:-2.0771,y:-1.2752,z:-.135},pos:{x:-3.7033,y:3.0318,z:3.3552}},[a.AWM]:{rot:{x:-1.592,y:-3.2155,z:-3.3508},pos:{x:-6.9809,y:-2.2309,z:23.0176}},[a.M14]:{rot:{x:-1.7355,y:-1.4831,z:-.2092},pos:{x:2.945,y:6.3715,z:-1.4664}},[a.M4A1]:{rot:{x:-2.0078,y:-1.4138,z:-.135},pos:{x:-1.7336,y:4.3863,z:1.8422}},[a.MG34]:{rot:{x:-1.6613,y:-3.2848,z:-3.3508},pos:{x:-12.2747,y:-2.8926,z:21.694}},[a.MOSSBERG]:{rot:{x:-1.7999,y:-1.4138,z:-.2092},pos:{x:-1.0253,y:1.7394,z:-.8512}},[a.MP5]:{rot:{x:-2.0077,y:-1.4138,z:-.2092},pos:{x:-1.6871,y:1.7395,z:-.8512}},[a.HK_MG5]:{rot:{x:-1.7355,y:-1.4386,z:-.2092},pos:{x:.0524,y:3.9573,z:-1.0451}},[a.MPX_COPPERHEAD]:{rot:{x:-1.8249,y:-1.4386,z:-.2092},pos:{x:-1.9275,y:2.8312,z:-.8512}}},idle3:{[a.CROSSBOW]:{rot:{x:-1.3019,y:-4.8642,z:-3.1778},pos:{x:-.0465,y:8.475,z:6.3693}},[a.VSS_VINTOREZ]:{rot:{x:-1.584,y:-4.8642,z:-3.1778},pos:{x:2.6469,y:6.4898,z:6.3693}},[a.AKM]:{rot:{x:-1.584,y:-4.8642,z:-3.1778},pos:{x:-.0465,y:4.4581,z:6.3693}},[a.AWM]:{rot:{x:-1.7177,y:-3.0576,z:-6.3194},pos:{x:11.2494,y:-9.3916,z:-10.1273}},[a.M14]:{rot:{x:-1.6485,y:-4.6514,z:-3.1778},pos:{x:-3.3085,y:4.5046,z:10.3862}},[a.M4A1]:{rot:{x:-1.3019,y:-4.8642,z:-3.1778},pos:{x:1.3235,y:3.1812,z:5.1389}},[a.MG34]:{rot:{x:-1.5791,y:-2.9883,z:-6.3194},pos:{x:8.6025,y:-.7892,z:-12.1125}},[a.MOSSBERG]:{rot:{x:-1.584,y:-4.8642,z:-3.1778},pos:{x:-.0465,y:5.8281,z:8.401}},[a.MP5]:{rot:{x:-1.9256,y:-4.79,z:-2.6186},pos:{x:0,y:3.8429,z:7.0776}},[a.MPX_COPPERHEAD]:{rot:{x:-1.584,y:-4.8642,z:-3.1778},pos:{x:2.3995,y:4.2642,z:7.4953}}}});m(this,"DEBUG",!1);m(this,"DEBUG_WEAPON_NAME",a.CROSSBOW);this.lobbyScene=t;const e=t.lobbyPlayerInitInfo;this.DEBUG?(setTimeout(()=>{this.addPlayer(-1,e.characterSkin,this.DEBUG_WEAPON_NAME,this.DEBUG_WEAPON_NAME),this.addPlayer(0,e.characterSkin,this.DEBUG_WEAPON_NAME,this.DEBUG_WEAPON_NAME,"Guest"),this.addPlayer(1,e.characterSkin,this.DEBUG_WEAPON_NAME,this.DEBUG_WEAPON_NAME,"Guest")},300),this.lobbyScene.systemsManager.registerSystem(new J(this.lobbyScene)),this.lobbyScene.systemsManager.removeSystem(Q)):this.addPlayer(-1,e.characterSkin,e.weaponName,e.weaponSkin)}removePlayer(t){const e=this.players[t];if(e)return e.mixer&&(e.mixer.stopAllAction(),e.mixer.uncacheRoot(e.mixer.getRoot())),e.model&&(e.model.removeFromParent(),_(e.model)),delete this.players[t],e.slot}addPlayer(t,e,r,s,o,n=""){return z(this,null,function*(){if(this.players[t])return;const y=Object.keys(this.players).length;if(y===3)return console.error("Currently there are 3 players in the lobby! Cant add player in the lobby!");let l=d["game/characters/animations/LobbyIdle1.glb"],i=this.WEAPONS_TRANSFORMS.idle1,f="middle";if(y==1)l=d["game/characters/animations/LobbyIdle2.glb"],i=this.WEAPONS_TRANSFORMS.idle2,f="right";else for(let B in this.players)if(this.players[B].slot==="right"){l=d["game/characters/animations/LobbyIdle3.glb"],i=this.WEAPONS_TRANSFORMS.idle3,f="left";break}this.players[t]={weaponName:r,weaponSkin:s,characterSkin:e,slot:f};const c=this.players[t],[w,M,x,G,T]=yield Promise.all([S.loadGltf(d["game/characters/character.glb"],!0),S.loadTexture(d[`game/characters/skins/${e}/1024/1024.ktx2`]),S.loadWeapon(r,s,!0),S.loadGltf(l),S.getOrLoadCachedTexture(d["game/lobby/heroShadow.webp"])]);if(this.disposed||!this.players[t])return;M.flipY=!1,M.magFilter=E,this.lobbyScene.threeScene.renderer.capabilities.isWebGL2?M.minFilter=I:(M.minFilter=E,M.generateMipmaps=!1);const p=C(w.scene),b=new N({map:M});p.scale.multiplyScalar(.85),U(p,b),this.lobbyScene.threeScene.scene.add(p),b.color.multiplyScalar(.85),y===0?(p.position.set(17.65,0,.5),p.rotation.y+=Math.PI*1.16):y===1?(p.position.set(16.6,0,1.6),p.rotation.y+=Math.PI*1.05):(p.position.set(19,0,.2),p.rotation.y+=Math.PI*1.27);const g=new H(p),u=g.clipAction(G.animations[0]);u.loop=j,u.reset().play();const A=new v(new V,new N({map:T,side:K,transparent:!0,color:new $("black"),opacity:.3}));A.rotation.x+=Math.PI/2,p.add(A),A.position.y+=.01,c.model=p,p.getObjectByName(f==="left"?"mixamorigLeftHand":"mixamorigRightHand").add(x.model),x.model.scale.copy(R[r]||W);const P=i[r]||i[a.AKM];return x.model.position.copy(P.pos),x.model.rotation.set(P.rot.x,P.rot.y,P.rot.z),this.DEBUG&&(f=="right"&&r===this.DEBUG_WEAPON_NAME?new O().addObj3D(x.model,"weapon_idle2_right",30):f==="left"&&r===this.DEBUG_WEAPON_NAME?new O().addObj3D(x.model,"weapon_idle3_left",30):new O().addObj3D(x.model,"weapon_idle1_middle",30)),o?this.createPlayerLabel(t,o,n):t==-1&&this.localPlayerNameData&&this.createPlayerLabel(t,this.localPlayerNameData.name,this.localPlayerNameData.label),c.mixer=g,c.weaponModel=x.model,r!==c.weaponName?this.changePlayerWeapon(t,c.weaponName,c.weaponSkin,!0):s!==c.weaponSkin&&this.changePlayerWeaponSkin(t,c.weaponSkin,!0),e!==c.characterSkin&&this.changePlayerSkin(t,c.characterSkin),f})}createPlayerLabel(t,e,r=""){const s=this.players[t];if(!s)return;if(!s.model){t===-1&&(this.localPlayerNameData={name:e,label:r});return}const o=Y(100,e,!1,r,"#ffffff"),n=o.sprite;n.name="nameSprite",s.model.updateMatrixWorld(!0);const y=s.model.getObjectByName("mixamorigSpine"),l=y.getObjectByName("nameSprite");l&&l.removeFromParent(),y.add(n);let i=new X().setFromMatrixScale(y.matrixWorld);(i.x==1||i.y==1||i.z==1)&&i.set(.008680473178757366,.008680473620956343,.008680473620871293),n.scale.x*=1/i.x,n.scale.y*=1/i.y,n.scale.z*=1/i.z,o.sprite.position.y=(q+.2)*(1/i.y/2)-o.scale*.025*(1/i.y/2)}changePlayerSkin(t,e,r=!1){return z(this,null,function*(){const s=this.players[t];if(!s||e===s.characterSkin&&!r||(s.characterSkin=e,!s.model))return;const o=yield S.loadTexture(d[`game/characters/skins/${e}/1024/1024.ktx2`]);if(this.disposed||!this.players[t]||s.characterSkin!==e)return;const n=D(s.model);n.map=o})}changePlayerWeapon(t,e,r,s=!1){return z(this,null,function*(){const o=this.players[t];if(!o)return;if(o.weaponName===e&&!s){o.weaponSkin!==r&&this.changePlayerWeaponSkin(t,r);return}if(o.weaponName=e,o.weaponSkin=r,!o.model||!o.weaponModel)return;o.weaponModel.removeFromParent(),_(o.weaponModel);const n=yield S.loadWeapon(e,r,!0);if(this.disposed||!this.players[t]||e!==o.weaponName)return;o.model.getObjectByName("mixamorigRightHand").add(n.model),n.model.scale.copy(R[e]||W),o.weaponModel=n.model;let l;o.slot==="middle"?l=this.WEAPONS_TRANSFORMS.idle1:o.slot==="right"?l=this.WEAPONS_TRANSFORMS.idle2:l=this.WEAPONS_TRANSFORMS.idle3;const i=l[e]||l[a.AKM];n.model.position.copy(i.pos),n.model.rotation.set(i.rot.x,i.rot.y,i.rot.z)})}changePlayerWeaponSkin(t,e,r=!1){return z(this,null,function*(){const s=this.players[t];if(!s||e===s.weaponSkin&&!r||(s.weaponSkin=e,!s.weaponModel))return;const o=s.weaponName;let n=d[`game/weapons/${o}/skins/${e}/1024.ktx2`];n||(n=d[`game/weapons/${o}/skins/${e}/1024.png`],console.error(`there is no 1024.ktx2 color map by src: game/weapons/${o}/skins/${e}/1024.ktx2`));const y=yield S.loadTexture(n);if(this.disposed||!this.players[t]||s.weaponSkin!==e)return;y.flipY=!1,y.encoding=Z,y.magFilter=E,y.minFilter=E,y.generateMipmaps=!1;const l=D(s.weaponModel);l.map=y})}onRemove(){this.disposed=!0,Object.keys(this.players).forEach(t=>{this.removePlayer(t)})}execute(t){for(let e in this.players){const r=this.players[e];r.mixer&&r.mixer.update(t)}}}export{ne as LPlayersSystem};
