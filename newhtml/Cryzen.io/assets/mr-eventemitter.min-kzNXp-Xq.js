var _=Object.defineProperty;var A=(n,t,e)=>t in n?_(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var a=(n,t,e)=>(A(n,typeof t!="symbol"?t+"":t,e),e),v=(n,t,e)=>{if(!t.has(n))throw TypeError("Cannot "+e)};var m=(n,t,e)=>(v(n,t,"read from private field"),e?e.call(n):t.get(n)),u=(n,t,e)=>{if(t.has(n))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(n):t.set(n,e)},E=(n,t,e,i)=>(v(n,t,"write to private field"),i?i.call(n,e):t.set(n,e),e);var S=(n,t,e,i)=>({set _(s){E(n,t,s,e)},get _(){return m(n,t,i)}});import{a as p}from"./ResourceLoader-DSKOvWHX.js";class b{constructor(t=!1){a(this,"activeSystems",[]);a(this,"notActiveSystems",[]);a(this,"passIndex",0);a(this,"needStats");a(this,"executeSystems");if(this.needStats=t,t){const e=new I;this.executeSystems=i=>{for(e.start(),this.passIndex=0;this.passIndex<this.activeSystems.length;this.passIndex++){const s=this.activeSystems[this.passIndex];s.execute(i),e.add(s.constructor.name)}e.end(),e.consoleLog(i,2)};return}this.executeSystems=e=>{for(this.passIndex=0;this.passIndex<this.activeSystems.length;this.passIndex++)try{this.activeSystems[this.passIndex].execute(e)}catch(i){console.error(`[SystemsManager] ${this.activeSystems[this.passIndex].constructor.name}`,i)}}}registerSystem(t){return t.inactiveInit||!t.execute?this.notActiveSystems.push(t):this._registerActiveSystem(t),this}registerSystems(...t){return t.forEach(e=>{this.registerSystem(e)}),this}playSystem(t){if(!t.prototype.execute)return!1;const e=this.notActiveSystems;for(let i=e.length-1;i>=0;i--){const s=e[i];if(s instanceof t)return e.splice(i,1),this._registerActiveSystem(s,!0),s.onPlay&&s.onPlay(),s}return!1}stopSystem(t){const e=this.activeSystems;for(let i=e.length-1;i>=0;i--){if(!(e[i]instanceof t))continue;const s=e[i];return e.splice(i,1),this.notActiveSystems.push(s),s.onStop&&s.onStop(),i<=this.passIndex&&this.passIndex--,!0}return!1}getSystem(t){const e=this.activeSystems;for(let s=e.length-1;s>=0;s--)if(e[s]instanceof t)return e[s];const i=this.notActiveSystems;for(let s=i.length-1;s>=0;s--)if(i[s]instanceof t)return i[s]}removeSystems(...t){return t.forEach(e=>{this.removeSystem(e)}),this}removeSystem(t){return t.prototype.execute?this._removeActiveSystem(t)||this._removeNotActiveSystem(t):this._removeNotActiveSystem(t),this}dispose(){this.activeSystems.forEach(t=>{this.getSystem(Object.getPrototypeOf(t).constructor)&&t.onRemove&&t.onRemove()}),this.notActiveSystems.forEach(t=>{this.getSystem(Object.getPrototypeOf(t).constructor)&&t.onRemove&&t.onRemove()}),this.activeSystems=[],this.notActiveSystems=[]}_registerActiveSystem(t,e=!1){if(!t.execute)return this;if(t.inactiveInit&&!e)return this.notActiveSystems.push(t),this;let i=t.priority||p.DEFAULT;const s=this.activeSystems;let o=s.length;for(let r=s.length-1;r>=0;r--){if(s[r].constructor==t.constructor)return console.error("System already exists",t.constructor.name),this;if(i>=(s[r].priority||p.DEFAULT))o=r;else break}return s.splice(o,0,t),o<=this.passIndex&&this.passIndex++,this}_removeActiveSystem(t){var i;const e=this.activeSystems;for(let s=e.length-1;s>=0;s--){if(!(e[s]instanceof t))continue;const o=e[s];return e.splice(s,1),(i=o.onRemove)==null||i.call(o),s<=this.passIndex&&this.passIndex--,!0}return!1}_removeNotActiveSystem(t){var i;const e=this.notActiveSystems;for(let s=e.length-1;s>=0;s--){if(!(e[s]instanceof t))continue;const o=e[s];return e.splice(s,1),(i=o.onRemove)==null||i.call(o),!0}return!1}}var l,f;class I{constructor(){a(this,"accumulator",0);u(this,l,new Array(20));u(this,f,0);a(this,"values");a(this,"privatePerfNow",0);a(this,"generalPerfNow",0);a(this,"timeStarted",0);a(this,"lastElapsed",0);a(this,"count",0);a(this,"total",0);a(this,"min",1e3);a(this,"max",-1e3);this.values={}}add(t){let e=this.values[t];e||(e=this.values[t]={min:1e4,max:-1e4,avg:0,sum:0});const i=performance.now()-this.privatePerfNow;i<2&&i>0&&(e.min=Math.min(i,e.min),e.max=Math.max(i,e.max),e.sum+=i,e.avg=e.sum/this.count),this.privatePerfNow=performance.now()}start(){this.count++,this.count==1&&(this.timeStarted=Date.now()),this.privatePerfNow=this.generalPerfNow=performance.now()}end(){this.generalPerfNow!=null&&(this.lastElapsed=performance.now()-this.generalPerfNow,m(this,l)[S(this,f)._++%m(this,l).length]=this.lastElapsed,this.total+=this.lastElapsed,this.lastElapsed<this.min&&(this.min=this.lastElapsed),this.lastElapsed>this.max&&(this.max=this.lastElapsed))}consoleLog(t,e){if(this.accumulator+=t,this.accumulator>e){const i=Object.keys(this.values).sort((h,c)=>this.values[c].avg-this.values[h].avg);let s=0,o=0;const r=i.map(h=>{const c=this.values[h],y=`${h}${" ".repeat(Math.abs(30-h.length-(s>=10?1:0)))}`,g=`${c.avg}${" ".repeat(25-c.avg.toString().length)}`,x=`${c.sum}${" ".repeat(25-c.sum.toString().length)}`,w=`${c.min}${" ".repeat(25-c.min.toString().length)}`;return s++,o+=c.avg,`${y}: avg: ${g} sum: ${x} min: ${w} max: ${c.max}`});console.log({res:r,elapsedTime:Date.now()-this.timeStarted,avgGeneral:o}),this.accumulator%=e}}}l=new WeakMap,f=new WeakMap;class d{constructor(){this._events=new Map}on(t,e,i,s=!1){const o=new $(this,t,e,i||this,s);let r=this._events.get(t);return r||(r=new Set,this._events.set(t,r)),r.add(o),o}once(t,e,i){return this.on(t,e,i,!0)}emit(t,...e){if(!this._events.has(t))return;const i=new Set(this._events.get(t));for(let s of i)s.emit(...e)}off(t,e,i){if(t){if(t instanceof RegExp)for(const s of this._events.keys())s.match(t)&&this.off(s);else if(e){if(!this._events.has(t))return;i=i||this;const s=this._events.get(t),o=new Set(s);for(let r of o)r.callback===e&&r.scope===i&&(s.delete(r),r.destroy());s.size===0&&this._events.delete(t)}else if(this._events.has(t)){for(let s of this._events.get(t))s.destroy();this._events.delete(t)}}else{for(let s of this._events.values())for(let o of s)o.destroy();this._events.clear()}}}class ${constructor(t,e,i,s,o=!1){this.owner=t,this.name=e,this.callback=i,this.scope=s,this.once=o}emit(...t){this.callback.apply(this.scope,t),this.once&&this.off()}off(){if(!this.owner||!this.owner._events.has(this.name))return;const t=this.owner._events.get(this.name);t.delete(this),t.size===0&&this.owner._events.delete(this.name),this.destroy()}destroy(){this.owner=null,this.name=null,this.callback=null,this.scope=null}}typeof module!="undefined"&&(module.exports=d),typeof window!="undefined"&&(window.EventEmitter=d);export{d as E,b as S};
